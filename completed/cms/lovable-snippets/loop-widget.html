<!-- SERP Loop Radio Widget for Lovable CMS -->
<div class="serp-loop-widget" style="
  background: linear-gradient(135deg, #0066cc, #6b46c1);
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  color: white;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
">
  {% if user_logged_in %}
    <!-- Authenticated User Experience -->
    <div class="widget-header" style="text-align: center; margin-bottom: 20px;">
      <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 600;">
        üéµ Your SERP Loop Radio
      </h3>
      <p style="margin: 0; opacity: 0.8; font-size: 14px;">
        Personalized audio from your ranking data
      </p>
    </div>

    <div class="audio-container" style="
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    ">
      {% if signed_hls %}
        <!-- Audio Player with HLS Support -->
        <audio 
          id="serp-audio-player" 
          controls 
          preload="metadata"
          style="width: 100%; margin-bottom: 12px;"
        >
          <source src="{{ signed_hls }}" type="application/vnd.apple.mpegurl">
          <source src="{{ signed_hls | replace: '.m3u8', '.mp3' }}" type="audio/mpeg">
          Your browser does not support the audio element.
        </audio>
        
        <!-- Playback Controls -->
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <button 
            onclick="togglePlayback()" 
            id="play-toggle"
            style="
              background: rgba(255, 255, 255, 0.2);
              border: none;
              border-radius: 6px;
              color: white;
              padding: 8px 16px;
              font-size: 14px;
              cursor: pointer;
              transition: background 0.2s;
            "
            onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
            onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
          >
            ‚ñ∂Ô∏è Play Loop
          </button>
          
          <div style="font-size: 12px; opacity: 0.7;">
            Duration: ~60s
          </div>
        </div>
      {% else %}
        <!-- Generate Button -->
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 32px; margin-bottom: 12px;">üéõÔ∏è</div>
          <button 
            onclick="generateLoop()"
            id="generate-btn"
            style="
              background: #059669;
              border: none;
              border-radius: 8px;
              color: white;
              padding: 12px 24px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
              transition: background 0.2s;
            "
            onmouseover="this.style.background='#047857'"
            onmouseout="this.style.background='#059669'"
          >
            Generate My Loop
          </button>
          <p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.7;">
            Create audio from your latest ranking data
          </p>
        </div>
      {% endif %}
    </div>

    <!-- Status Indicator -->
    <div style="display: flex; justify-content: space-between; font-size: 12px; opacity: 0.8;">
      <span>üü¢ Connected</span>
      <span>Last updated: {{ current_time | date: '%H:%M' }}</span>
    </div>

  {% else %}
    <!-- Non-Authenticated Experience -->
    <div style="text-align: center;">
      <div style="font-size: 32px; margin-bottom: 12px;">üéµ</div>
      <h3 style="margin: 0 0 8px 0; font-size: 18px;">
        SERP Loop Radio
      </h3>
      <p style="margin: 0 0 16px 0; font-size: 14px; opacity: 0.8;">
        Transform your search rankings into personalized audio
      </p>
      
      <a 
        href="/setup" 
        style="
          display: inline-block;
          background: rgba(255, 255, 255, 0.2);
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 8px;
          color: white;
          padding: 10px 20px;
          text-decoration: none;
          font-weight: 500;
          transition: all 0.2s;
          margin-right: 8px;
        "
        onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
        onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
      >
        Create Your Loop ‚Üí
      </a>
      
      <a 
        href="/play" 
        style="
          display: inline-block;
          background: transparent;
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 8px;
          color: white;
          padding: 10px 20px;
          text-decoration: none;
          font-weight: 500;
          transition: all 0.2s;
        "
        onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'"
        onmouseout="this.style.background='transparent'"
      >
        Demo
      </a>
    </div>
  {% endif %}
</div>

<script>
// Widget JavaScript functionality
(function() {
  let audio = null;
  let isPlaying = false;

  window.togglePlayback = function() {
    audio = audio || document.getElementById('serp-audio-player');
    const button = document.getElementById('play-toggle');
    
    if (!audio) return;

    if (isPlaying) {
      audio.pause();
      button.textContent = '‚ñ∂Ô∏è Play Loop';
      isPlaying = false;
    } else {
      audio.play();
      button.textContent = '‚è∏Ô∏è Pause';
      isPlaying = true;
    }
  };

  window.generateLoop = function() {
    const button = document.getElementById('generate-btn');
    button.textContent = 'üéµ Generating...';
    button.disabled = true;
    
    // Call API to generate loop
    fetch('{{ api_base_url }}/setup', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        user_id: '{{ user.id }}'
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.payload_key) {
        // Call renderer
        return fetch('{{ api_base_url }}/play?user_id={{ user.id }}');
      }
      throw new Error('Failed to generate payload');
    })
    .then(response => response.json())
    .then(data => {
      if (data.signed_url) {
        // Reload page to show audio player
        window.location.reload();
      } else {
        throw new Error('Failed to generate audio');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      button.textContent = '‚ùå Error - Try Again';
      button.disabled = false;
      setTimeout(() => {
        button.textContent = 'Generate My Loop';
      }, 3000);
    });
  };

  // Auto-load HLS.js if needed
  if (document.getElementById('serp-audio-player')) {
    const audio = document.getElementById('serp-audio-player');
    const source = audio.querySelector('source[type="application/vnd.apple.mpegurl"]');
    
    if (source && typeof Hls !== 'undefined') {
      // Use HLS.js for better browser support
      const hls = new Hls();
      hls.loadSource(source.src);
      hls.attachMedia(audio);
    }
  }
})();
</script>

<style>
/* Widget-specific styles */
.serp-loop-widget button:hover {
  transform: translateY(-1px);
}

.serp-loop-widget audio::-webkit-media-controls-panel {
  background-color: rgba(255, 255, 255, 0.1);
}

.serp-loop-widget audio::-webkit-media-controls-play-button,
.serp-loop-widget audio::-webkit-media-controls-pause-button {
  background-color: rgba(255, 255, 255, 0.8);
  border-radius: 50%;
}
</style> 